# django_aiogram_template

Для запуска требуется установка docker и docker compose.

1. Скопировать проект на сервер в папку пользователя (далее 'user')
2. переименовать файл .env.example в .env и заполнить переменные
3. в папке выполнить команду
```
sudo docker compose up -d
```
4. Cоздать пользователя для входа в админ-панель
```
sudo docker compose exec admin_panel python manage.py createsuperuser
```
После чего ввести имя, почту (можно выдуманную, но валидную) и пароль для админки
5. Загрузить дефолтные конфиги в админ-панель
```
sudo docker compose exec admin_panel python manage.py load_config
```
## Пересборка контейнера
```
sudo docker compose down
sudo docker compose up -d --build
```
## Выгрузить логи
```
docker compose cp bot:logs bot_logs
docker compose cp admin_panel:logs admin_panel_logs
```

## Отправка медиа-рассылки.
Для того что бы рассылать медиа-файлы пользователям (в т.ч. картинки тренировок) нужно:

1. Зарегистрироваться пользователем-админом в Боте.
2. Зайти в админ-панель и в разделе "Пользователи Telegram" установить галочку  "Is admin", после чего нажать кнопку "СОХРАНИТЬ"

## Для отладки кода:
создать виртуальное окружение

py -3.11 -m venv venv
source venv/Scripts/activate

установить зависимости
```
poetry config virtualenvs.create false
poetry install
```
Запуск сервер
```
python manage.py runserver
```
Запуск бота
```
python manage.py runbot
```
## Настройка Веб-хука ЮКАССА
Кроме API_KEY и SHOP_ID (в файле ```.env```) рекомендуется настроить отправку уведомлений от сервиса Юкасса на ваш сервер.
В проекте реализовано регулярное обновление статусов платежей Юкассы (обновляются все кроме завершенных "succeeded"). Частота обновления в минутах устанавливается в файле ```.env```

Для того что бы статусы платежа обновлялись моментально реализовано API c одним
эндпоинтом
```
https://yourserverurl.com/api/payment/
```
Соответственно, рекомендуется использовать его чтобы не загружать сервер бота и 
обеспечить пользователю быструю реакцию на завершенный платеж.
В личном кабинете Юкассы нужно указать вашу ссылку в разделе Интеграция-> HTTP-уведомления.
**Сервер nginx должен уметь обрабатывать HTTPS-запросы.**